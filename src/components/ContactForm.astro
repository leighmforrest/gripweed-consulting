---

---

<div
  class="relative not-content sm:mx-4 sm:my-3 dark:text-gray-100 p-6 text-gray-900 rounded-xl overflow-hidden"
>
  <form
    novalidate
    id="contact-form"
    name="contact-form"
    class="mt-4 sm:mt-0 flex flex-col gap-3 border rounded-xl p-4 border-gray-400 dark:border-gray-500"
    method="post"
  >
    <h2 class="text-4xl text-vermillion dark:text-dark-vermillion text-center">
      Contact Us
    </h2>
    <input type="hidden" name="form-name" value="contact" />
    <div>
      <label for="contact-name" class="mb-1 text-gray-600">Name</label>
      <input
        type="text"
        class="form__input bg-gray-200 dark:bg-gray-600 placeholder:text-gray-500 dark:placeholder:text-gray-300"
        name="name"
        id="contact-name"
        placeholder="Your preferred name"
        required
      />
      <p class="text-red-500 text-sm mt-1 hidden error-message"></p>
    </div>
    <div>
      <label for="contact-email" class="mb-1 text-gray-600">Email</label>
      <input
        type="email"
        class="form__input bg-gray-200 dark:bg-gray-600 placeholder:text-gray-500 dark:placeholder:text-gray-300"
        name="email"
        id="contact-email"
        inputmode="email"
        placeholder="Your best contact email"
        required
      />
      <p class="text-red-500 text-sm mt-1 hidden error-message"></p>
    </div>
    <div>
      <label for="contact-message" class="text-gray-600">Message</label>
      <textarea
        name="message"
        class="form__input bg-gray-200 dark:bg-gray-700 placeholder:text-gray-500 dark:placeholder:text-gray-300 resize-none"
        id="contact-message"
        rows="4"
        placeholder="write your message here"
        required></textarea>
      <p id="char-count" class="text-sm text-green-500" aria-live="polite"></p>
      <p class="text-red-500 text-sm mt-1 hidden error-message"></p>
    </div>
    <!-- honeypot field to catch bots.  -->
    <label for="emmie" class="sr-only">Real users skip this field</label>
    <input id="emmie" type="text" name="emmie" class="sr-only" tabindex="-1" />
    <span>This contact form is for professional inquiries only.</span>
    <button
      type="submit"
      class="submit-button focus-visible:ring-opacity-50 flex items-center justify-center gap-2 rounded-md bg-blue-600 p-2.5 text-white transition hover:bg-blue-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-600"
    >
      <svg
        id="spinner"
        class="hidden w-5 h-5 animate-spin text-white"
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
      >
        <circle
          class="opacity-25"
          cx="12"
          cy="12"
          r="10"
          stroke="currentColor"
          stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"
        ></path>
      </svg>
      <span id="submit-text">Submit</span>
    </button>
  </form>
  <!-- Success Panel -->
  <div
    id="success-panel"
    class="hidden absolute inset-0 z-20 flex items-center justify-center bg-green-500 text-white"
  >
    <div class="text-center max-w-md">
      <h3 class="text-2xl font-medium">Success!</h3>
      <p class="mt-4">
        We have received your message. You will be hearing from us soon!
      </p>
    </div>
  </div>

  <!-- Failure Panel -->
  <div
    id="failure-panel"
    class="hidden absolute inset-0 z-20 flex items-center justify-center bg-gray-800/95 text-white"
  >
    <div class="text-center max-w-md">
      <h3 class="text-2xl font-medium">Failure!</h3>
      <p class="mt-4">Something went wrong!</p>
    </div>
  </div>
</div>

<style>
  @import "tailwindcss/theme" theme(reference);

  .form__input {
    @apply w-full rounded-md border-2 p-2.5 transition outline-none;
    @apply focus-visible:border-blue-600/70 focus-visible:ring-2 focus-visible:ring-blue-600/50;
  }

  .form__input.error {
    @apply border-red-500;
  }

  #spinner {
    @apply transition-opacity duration-500;
  }
</style>
<script>
  import { showError, clearError, markValid } from "../scripts/contactForm";

  const endpoint = import.meta.env.PUBLIC_API_URL;
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  const fields = {
    name: { length: { min: 5, max: 50 } },
    email: {
      length: { min: 5, max: 50 },
      pattern: {
        regex: emailRegex,
        message: "Please enter a valid email address.",
      },
    },
    message: { length: { min: 5, max: 500 } },
  };

  document.addEventListener("DOMContentLoaded", () => {
    const contactForm = document.querySelector("#contact-form");
    const successPanel = document.querySelector("#success-panel");
    const failurePanel = document.querySelector("#failure-panel");
    const submitButton = document.querySelector(".submit-button");
    const submitText = document.querySelector("#submit-text");
    const spinner = document.querySelector("#spinner");
    const charCount = document.querySelector("#char-count"); // for message char count
    const allItems = [contactForm, successPanel, failurePanel];

    const hideAll = () =>
      allItems.forEach((item) => item?.classList.add("hidden"));

    // ---------- FIELD VALIDATION ----------
    const validateField = (field) => {
      const input = contactForm.querySelector(`[name="${field}"]`);
      const value = input?.value.trim();

      // reset errors
      clearError(input);

      // Required
      if (!value) {
        showError(input, "This field is required.");
        return false;
      }

      // Length check
      const { min, max } = fields[field].length;
      if (value.length < min || value.length > max) {
        showError(input, `Must be between ${min} and ${max} characters.`);
        return false;
      }

      // Regex check (if defined)
      if (fields[field].pattern && !fields[field].pattern.regex.test(value)) {
        showError(input, fields[field].pattern.message);
        return false;
      }

      // Valid
      markValid(input);
      return true;
    };

    // Attach blur validation to each field
    Object.keys(fields).forEach((field) => {
      const input = contactForm.querySelector(`[name="${field}"]`);
      if (!input) return;
      input.addEventListener("blur", () => validateField(field));
    });

    // Optional: update char count for message field
    const messageInput = contactForm.querySelector("[name='message']");
    if (messageInput && charCount) {
      messageInput.addEventListener("input", () => {
        charCount.textContent = `${messageInput.value.length}/${fields.message.length.max} chars`;
      });
    }

    if (messageInput && charCount) {
      messageInput.addEventListener("input", () => {
        const len = messageInput.value.length;
        const min = fields.message.length.min;
        const max = fields.message.length.max;

        charCount.textContent = `${len}/${max} chars`;

        if (len < min || len > max) {
          // Invalid length → red
          charCount.classList.remove("text-green-500");
          charCount.classList.add("text-red-500");
        } else {
          // Valid length → green
          charCount.classList.remove("text-red-500");
          charCount.classList.add("text-green-500");
        }
      });
    }

    // ---------- FORM SUBMISSION ----------
    contactForm?.addEventListener("submit", async (e) => {
      e.preventDefault();

      // Honeypot check
      const honeypot = contactForm.querySelector("[name='emmie']");
      if (honeypot?.value) return;

      // Validate all fields
      let isValid = true;
      Object.keys(fields).forEach((field) => {
        if (!validateField(field)) isValid = false;
      });
      if (!isValid) return;

      const formData = new FormData(contactForm); // correct FormData
      const formValues = Object.fromEntries(formData); // optional for JSON

      // Button / spinner state
      submitButton.disabled = true;
      submitText.textContent = "Sending";
      spinner.classList.remove("hidden");

      try {
        const response = await fetch(endpoint, {
          method: "POST",
          headers: { Accept: "application/json" },
          body: formData, // or JSON.stringify(formValues) if API expects JSON
        });

        if (response.ok) {
          hideAll();
          successPanel?.classList.remove("hidden");
          if (charCount) charCount.textContent = "";

          // reset form
          contactForm?.reset();

          contactForm.querySelectorAll(".form__input").forEach((input) => {
            input.classList.remove("error", "border-green-500");
          });

          setTimeout(() => {
            successPanel?.classList.add("hidden");
            contactForm?.classList.remove("hidden");
          }, 8000);
        } else {
          hideAll();
          failurePanel?.classList.remove("hidden");
          setTimeout(() => {
            failurePanel?.classList.add("hidden");
            contactForm?.classList.remove("hidden");
          }, 8000);
        }
      } catch (error) {
        hideAll();
        failurePanel?.classList.remove("hidden");
      } finally {
        submitButton.disabled = false;
        submitText.textContent = "Submit";
        spinner.classList.add("hidden");
      }
    });
  });
</script>
